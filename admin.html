<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>IKAM Codex | High Council</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            fantasy: ['"Cinzel"', 'serif'],
            body: ['"Cormorant Garamond"', 'serif'],
          },
          colors: {
            'void': '#050505',
            'gold-dim': '#8a6a4b',
            'gold-bright': '#d4af37',
          }
        }
      }
    }
  </script>
  <style>
    body { background-color: #020203; color: #e5e5e5; }
    input {
      background: rgba(0,0,0,0.3); border: 1px solid #292524; color: #d6d3d1; font-family: 'Cormorant Garamond', serif;
    }
    input:focus { outline: none; border-color: #8a6a4b; }
    .hidden-section { display: none; }
  </style>
</head>
<body class="font-body bg-void min-h-screen p-6 flex items-center justify-center relative overflow-hidden">

  <!-- Background Runes -->
  <div class="absolute top-10 left-10 text-9xl text-stone-900/20 font-fantasy select-none -z-10">ᚠ</div>
  <div class="absolute bottom-10 right-10 text-9xl text-stone-900/20 font-fantasy select-none -z-10">ᚱ</div>

  <div class="max-w-4xl w-full bg-stone-950 border border-stone-800 p-8 relative shadow-2xl z-10">
    <!-- Decorative Corners -->
    <div class="absolute -top-1 -left-1 w-4 h-4 border-t border-l border-gold-dim"></div>
    <div class="absolute -top-1 -right-1 w-4 h-4 border-t border-r border-gold-dim"></div>
    <div class="absolute -bottom-1 -left-1 w-4 h-4 border-b border-l border-gold-dim"></div>
    <div class="absolute -bottom-1 -right-1 w-4 h-4 border-b border-r border-gold-dim"></div>

    <h1 class="text-3xl font-fantasy text-center text-stone-200 mb-2">HIGH COUNCIL</h1>
    <p class="text-center text-stone-500 text-xs tracking-[0.3em] uppercase mb-8">Restricted Access</p>

    <!-- LOGIN SECTION -->
    <div id="loginSection" class="text-center space-y-6 py-10 max-w-sm mx-auto">
      <p class="text-stone-400 italic">"Prove your authority."</p>

      <form id="adminLoginForm" class="space-y-4">
        <input type="email" id="emailInput" placeholder="Council Email" class="w-full p-3 text-center" required>
        <input type="password" id="passwordInput" placeholder="Secret Key" class="w-full p-3 text-center" required>
        <button type="submit" class="w-full py-3 bg-stone-900 border border-stone-700 text-stone-300 font-fantasy tracking-[0.2em] hover:bg-stone-800 hover:text-gold-bright hover:border-gold-dim transition-all">
          ENTER COUNCIL
        </button>
      </form>
      <p id="authErrorMsg" class="text-red-500 text-xs mt-2 hidden"></p>
    </div>

    <!-- DASHBOARD SECTION (Hidden) -->
    <div id="dashboardSection" class="hidden-section space-y-6">
      <div class="flex justify-between items-center border-b border-stone-800 pb-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-gold-dim flex items-center justify-center text-black font-bold font-fantasy">A</div>
          <div>
            <p class="text-xs text-stone-500 uppercase">Welcome, High Council</p>
            <p class="text-sm text-gold-dim font-fantasy tracking-wide" id="adminName">Admin</p>
          </div>
        </div>
        <button id="logoutBtn" class="text-xs text-red-900 hover:text-red-500 font-fantasy tracking-widest uppercase">Leave Council</button>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm text-stone-400">
          <thead class="text-xs text-stone-500 uppercase bg-stone-900/50 font-fantasy">
            <tr>
              <th class="px-4 py-3">Entity</th>
              <th class="px-4 py-3">Scribe (User)</th>
              <th class="px-4 py-3">Class</th>
              <th class="px-4 py-3 text-right">Action</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-stone-800">
            <!-- Rows injected by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- FIREBASE & LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
  apiKey: "AIzaSyBIiMVbWTxElmvbNf_m6zK-XaSnbXxwLk8",
  authDomain: "arufkuy-gallery.firebaseapp.com",
  projectId: "arufkuy-gallery",
  storageBucket: "arufkuy-gallery.firebasestorage.app",
  messagingSenderId: "554459431239",
  appId: "1:554459431239:web:49951746a0e2f42a234c62"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loginSection = document.getElementById('loginSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const authErrorMsg = document.getElementById('authErrorMsg');

    // --- AUTH LOGIC ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // CHECK ROLE
        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === 'admin') {
            // IS ADMIN
            loginSection.classList.add('hidden-section');
            dashboardSection.classList.remove('hidden-section');
            document.getElementById('adminName').innerText = user.email;
            loadData();
          } else {
            // NOT ADMIN
            await signOut(auth);
            authErrorMsg.innerText = "ACCESS DENIED: You are not a High Council member.";
            authErrorMsg.classList.remove('hidden');
          }
        } catch (e) {
          console.error(e);
          await signOut(auth);
        }
      } else {
        loginSection.classList.remove('hidden-section');
        dashboardSection.classList.add('hidden-section');
      }
    });

    document.getElementById('adminLoginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('emailInput').value;
      const pass = document.getElementById('passwordInput').value;
      signInWithEmailAndPassword(auth, email, pass).catch(err => {
        authErrorMsg.innerText = err.message;
        authErrorMsg.classList.remove('hidden');
      });
    });

    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

    // --- DASHBOARD LOGIC ---
    async function loadData() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Summoning records...</td></tr>';

      try {
        const q = query(collection(db, "archives"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);

        tbody.innerHTML = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const tr = document.createElement('tr');
          tr.className = "hover:bg-stone-900/30 transition-colors";
          tr.innerHTML = `
            <td class="px-4 py-3 font-fantasy text-stone-200">${data.title}</td>
            <td class="px-4 py-3">${data.scribeName || 'Unknown'}</td>
            <td class="px-4 py-3 text-xs uppercase">${data.class}</td>
            <td class="px-4 py-3 text-right">
              <button class="text-red-500 hover:text-red-400 text-xs uppercase tracking-wider border border-red-900/50 px-2 py-1 hover:bg-red-900/20" onclick="deleteItem('${docSnap.id}')">
                Banish
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
      }
    }

    window.deleteItem = async (id) => {
      if(confirm("Permanently BANISH this entity?")) {
        await deleteDoc(doc(db, "archives", id));
        loadData();
      }
    };
  </script>
</body>
</html>